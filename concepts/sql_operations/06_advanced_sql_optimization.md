# SQL 고급 기능 및 최적화

## 1. 절차형 SQL

### 1.1 절차형 SQL의 개념
- 일반적인 개발 언어처럼 SQL에서도 절차 지향적인 프로그래밍이 가능하도록 하는 트랜잭션 언어
- 복잡한 비즈니스 로직을 SQL로 구현 가능
- 여러 SQL 문을 하나의 블록으로 묶어서 실행

### 1.2 절차형 SQL의 종류

#### 1.2.1 프로시저 (Procedure)
- 일련의 쿼리들을 마치 하나의 함수처럼 실행하기 위한 쿼리의 집합
- 반복적으로 사용되는 SQL 문을 모듈화
- 매개변수를 받아 처리 가능
- 리턴값이 있을 수도 있고 없을 수도 있음

```sql
CREATE PROCEDURE 프로시저명 (매개변수)
AS
BEGIN
    SQL문;
    ...
END;
```

#### 1.2.2 사용자 정의 함수 (User-Defined Function)
- 일련의 SQL 처리를 수행하고, 수행 결과를 단일 값으로 반환
- 프로시저와 달리 반드시 하나의 값을 반환
- SELECT 문의 일부로 사용 가능

```sql
CREATE FUNCTION 함수명 (매개변수)
RETURNS 데이터타입
AS
BEGIN
    SQL문;
    RETURN 반환값;
END;
```

#### 1.2.3 트리거 (Trigger)
- 데이터베이스에서 특정 이벤트 발생 시 자동으로 실행되는 절차형 SQL
- INSERT, UPDATE, DELETE 등의 이벤트에 반응
- 데이터 무결성 유지, 로그 기록 등에 활용

```sql
CREATE TRIGGER 트리거명
ON 테이블명
FOR INSERT, UPDATE, DELETE
AS
BEGIN
    SQL문;
END;
```

## 2. SQL 최적화

### 2.1 SQL 튜닝의 개념
- 데이터베이스에서 SQL 실행 계획을 분석하고 수정하여 성능을 개선하는 작업
- 최소의 시간으로 원하는 결과를 얻도록 프로시저를 수정
- SQL 성능 개선을 통해 전체 시스템 성능 향상

### 2.2 SQL 튜닝의 주요 기법
- 인덱스 최적화
- 조인 최적화
- 서브쿼리 최적화
- WHERE 절 최적화
- GROUP BY 최적화

### 2.3 옵티마이저 (Optimizer)

#### 2.3.1 옵티마이저의 개념
- SQL을 가장 빠르고 효율적으로 수행할 최적의 처리경로를 생성하는 DBMS 내부의 핵심엔진
- 옵티마이저가 생성한 SQL 처리 경로를 실행계획(Execution Plan)이라 함

#### 2.3.2 옵티마이저의 유형

##### 규칙 기반 옵티마이저 (Rule Based Optimizer, RBO)
- 통계 정보 없이 사전 등록된 규칙에 따라 실행 계획 선택
- 규칙(우선순위) 기반으로 동작
  - 인덱스 구조
  - 연산자
  - 조건절 형태
- 장점: 사용자가 원하는 처리경로로 유도하기 쉬움
- 단점: 항상 최적의 실행 계획을 보장하지 않음

##### 비용 기반 옵티마이저 (Cost Based Optimizer, CBO)
- 통계 정보를 기반으로 모든 접근 경로를 고려하여 최적의 실행 계획 선택
- 비용(수행 시간) 기반으로 동작
- 고려하는 통계 정보:
  - 레코드 개수
  - 블록 개수
  - 평균 행 길이
  - 컬럼 값의 수
  - 컬럼 값 분포
  - 인덱스 높이
  - 클러스터링 팩터
- 장점: 옵티마이저의 이해도가 낮아도 성능 보장 가능
- 단점: 통계 정보가 정확하지 않으면 성능이 저하될 수 있음

### 2.4 실행 계획 (Execution Plan)

#### 2.4.1 실행 계획의 개념
- SQL 문을 실행하기 위한 세부적인 처리 절차
- 옵티마이저가 생성한 SQL 처리 경로
- EXPLAIN PLAN 명령으로 확인 가능

#### 2.4.2 실행 계획 분석
```sql
EXPLAIN PLAN FOR
SELECT * FROM 테이블;

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);
```

### 2.5 SQL 성능 개선 지침

#### 2.5.1 인덱스 관련
- 적절한 인덱스 생성
- 불필요한 인덱스 제거
- 선택도가 높은 컬럼에 인덱스 생성

#### 2.5.2 조인 관련
- 조인 순서 최적화
- 적절한 조인 방식 선택
- 조인 컬럼에 인덱스 생성

#### 2.5.3 WHERE 절 관련
- 인덱스 컬럼의 변형 지양
- LIKE 연산자 사용 시 와일드카드 위치 고려
- IN 대신 EXISTS 사용 검토

#### 2.5.4 기타
- 적절한 힌트 사용
- 통계 정보 최신화
- 실행 계획 주기적 모니터링